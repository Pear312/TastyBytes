{% extends "base.html" %}
{% block content %}

{% if recipe_list %}
<h1>All Recipes</h1>

<div class="recipe-grid">
    {% for r in recipe_list %}
    <a href="/recipe/{{ r[0] }}" class="recipe-card">
        <h3>{{ r[1] }}</h3>
        <p>{{ r[2][:120] }}...</p>
    </a>
    {% endfor %}
</div>

{% else %}

<h1>{{ recipe.title }}</h1>
<p style="font-size: 18px; color: #555;">{{ recipe.description }}</p>

<div class="info-box">
    <p><strong>Cook Time:</strong> {{ recipe.cook_time_min }} min</p>
    <p><strong>Servings:</strong> {{ recipe.servings }}</p>
</div>

<h2>Ingredients</h2>
<ul>
    {% for ing in ingredients %}
    <li>{{ ing.name }} — {{ ing.qty }}</li>
    {% endfor %}
</ul>

<h2>Instructions</h2>
<ol>
    {% for step in recipe.instructions.split('\n') %}
        {% if '. ' in step %}
            {% set clean_step = step.split('. ', 1)[1]
                                    .replace('°F','F')
                                    .replace('°','')
                                    .replace('Â°','') %}
        {% else %}
            {% set clean_step = step %}
        {% endif %}
        <li>{{ clean_step }}</li>
    {% endfor %}
</ol>

<h2>Tags</h2>
<div class="tag-box">
    {% for t in tags %}
    <span class="tag">{{ t }}</span>
    {% endfor %}
</div>

<h2>Comments</h2>
<ul class="comment-box">
    {% for c in comments %}
    <li style="margin-bottom: 20px;">
        <strong>{{ c.username or "Anonymous" }}</strong>

        {% if c.rating %}
            &nbsp;
            {% for i in range(c.rating) %}
                <span class="star">★</span>
            {% endfor %}
            {% for i in range(5 - c.rating) %}
                <span class="star" style="color:#ddd;">★</span>
            {% endfor %}
        {% endif %}

        {% if c.comment %}
        <div style="margin-top: 4px; font-size: 15px;">
            {{ c.comment }}
        </div>
        {% endif %}
    </li>
    {% endfor %}
</ul>

<hr>

<h3>Leave a Review</h3>

<form action="/review/{{ recipe.recipe_id }}" method="POST" class="review-form">

    <!-- STAR RATING -->
    <div class="star-rate">
        {% for i in range(1,6) %}
            <button 
                type="button" 
                class="star-button" 
                onclick="setRating({{ i }})"
                id="star-{{ i }}"
            >★</button>
        {% endfor %}
    </div>

    <input type="hidden" name="rating" id="rating-input" required>

    <!-- COMMENT TEXT -->
    <textarea name="comment" placeholder="Write your comment..." required></textarea>

    <button type="submit" class="submit-review-btn">Submit Review</button>
</form>

<script>
    function setRating(val) {
        document.getElementById("rating-input").value = val;

        // Highlight the stars
        for (let i = 1; i <= 5; i++) {
            let s = document.getElementById("star-" + i);
            if (i <= val) s.style.color = "gold";
            else s.style.color = "#ccc";
        }
    }
</script>

{% endif %}

{% endblock %}
