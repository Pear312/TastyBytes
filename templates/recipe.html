{% extends "base.html" %}
{% block content %}

{% if recipe_list %}
<h1>All Recipes</h1>

<div class="recipe-layout">

    <!-- FILTER SIDEBAR -->
    <div class="filter-sidebar">
        <h3>Filter by Tags</h3>

        <form action="/recipes" method="GET" class="filter-form">
            {% for t in all_tags %}
            <label class="filter-item">
                <input type="checkbox"
                       name="tags"
                       value="{{ t.tag_id }}"
                       {% if t.tag_id|string in selected_tags %}checked{% endif %}>
                {{ t.tag_name }}
            </label>
            {% endfor %}

            <button class="btn" style="margin-top:10px;">Apply</button>
        </form>
    </div>

    <!-- RECIPE GRID -->
    <div class="recipe-grid">
        {% for r in recipe_list %}
        <a href="/recipe/{{ r.recipe_id }}" class="recipe-card">
            <h3>{{ r.title }}</h3>
            <p>{{ r.description[:120] }}...</p>
        </a>
        {% endfor %}
    </div>

</div>

{% else %}

<!-- SINGLE RECIPE PAGE -->
<h1>{{ recipe.title }}</h1>
<p style="font-size: 18px; color: #555;">{{ recipe.description }}</p>


{# choose an image file based on recipe_id #}
{% if recipe.recipe_id == 1 %}
    {% set img_file = 'images/spaghettiCarbonara.jpg' %}
{% elif recipe.recipe_id == 2 %}
    {% set img_file = 'images/chocolateChipCookies.jpg' %}
{% elif recipe.recipe_id == 3 %}
    {% set img_file = 'images/chickenStirFry.jpg' %}
{% elif recipe.recipe_id == 4 %}
    {% set img_file = 'images/avocadoToastWithEgg.jpg' %}
{% elif recipe.recipe_id == 5 %}
    {% set img_file = 'images/bbqGrilledChicken.jpg' %}
{% else %}
    {% set img_file = 'images/placeholder.jpg' %}
{% endif %}

<div class="recipe-hero">
    <img src="{{ url_for('static', filename=img_file) }}"
         alt="{{ recipe.title }}"
         class="recipe-hero-img">
</div>

{% if session.get("user_id") %}
<form action="/favorite/{{ recipe.recipe_id }}" method="POST">
    <button type="submit"
        class="favorite-btn"
        style="
            padding: 8px 14px;
            border-radius: 6px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            background-color: {% if is_fav %}#28a745{% else %}#ff6b6b{% endif %};
            color: white;
        ">
        {% if is_fav %}
            ✓ Added to Favorites
        {% else %}
            ❤️ Add to Favorites
        {% endif %}
    </button>
</form>
{% endif %}

<div class="info-box">
    <p><strong>Cook Time:</strong> {{ recipe.cook_time_min }} min</p>
    <p><strong>Servings:</strong> {{ recipe.servings }}</p>
</div>

<h2>Ingredients</h2>
<ul>
    {% for ing in ingredients %}
    <li>{{ ing.name }} — {{ ing.qty }}</li>
    {% endfor %}
</ul>

<h2>Instructions</h2>
<ol>
    {% for step in recipe.instructions.split('\n') if step.strip() %}
        {% set s = step.strip() %}
        
        {% if s[0].isdigit() and '.' in s %}
            {% set clean_step = s.split('.', 1)[1].strip() %}
        {% else %}
            {% set clean_step = s %}
        {% endif %}

        <li>{{ clean_step }}</li>
    {% endfor %}
</ol>

<h2>Tags</h2>
<div class="tag-box">
    {% for t in tags %}
    <span class="tag">{{ t }}</span>
    {% endfor %}
</div>

<h2>Comments</h2>
<ul class="comment-box">
    {% for c in comments %}
    <li style="margin-bottom: 20px;">
        <strong>{{ c.username or "Anonymous" }}</strong>

        {% if c.rating %}
            {% for i in range(c.rating) %}
                <span class="star">★</span>
            {% endfor %}
            {% for i in range(5 - c.rating) %}
                <span class="star" style="color:#ddd;">★</span>
            {% endfor %}
        {% endif %}

        {% if c.comment %}
        <div style="margin-top: 4px; font-size: 15px;">
            {{ c.comment }}
        </div>
        {% endif %}
    </li>
    {% endfor %}
</ul>
<h3>Leave a Review</h3>

{% if session.get("user_id") %}

<form action="/review/{{ recipe.recipe_id }}" method="POST" class="review-form">

    <div class="star-rate" style="margin-bottom: 10px;">
        {% for i in range(1,6) %}
            <button 
                type="button" 
                class="star-button"
                id="star-{{ i }}"
                onclick="setRating({{ i }})"
                style="
                    background:none;
                    border:none;
                    font-size:26px;
                    cursor:pointer;
                    color:#ccc;
                "
            >★</button>
        {% endfor %}
    </div>

    <input type="hidden" name="rating" id="rating-input" required>

    <textarea name="comment" placeholder="Write your comment..." 
              required
              style="
                width:100%;
                max-width:500px;
                height:80px;
                padding:8px;
                border-radius:6px;
                border:1px solid #ccc;
                margin-bottom: 10px;
              ">
    </textarea>

    <button type="submit" 
            class="submit-review-btn"
            style="
                padding:8px 16px;
                border-radius:6px;
                border:none;
                background:#ffa500;
                color:white;
                font-weight:bold;
                cursor:pointer;
            ">
        Submit Review
    </button>

</form>

<script>
function setRating(val) {
    document.getElementById("rating-input").value = val;

    for (let i = 1; i <= 5; i++) {
        let s = document.getElementById("star-" + i);
        s.style.color = (i <= val) ? "gold" : "#ccc";
    }
}
</script>

{% else %}
<p style="color:#888; margin-top:10px;">
    <em>You must be logged in to leave a review.</em>
</p>
{% endif %}

{% endif %}
{% endblock %}
